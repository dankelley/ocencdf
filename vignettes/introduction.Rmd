---
title: "1. Introduction to ocencdf"
author: "Dan Kelley (https://orcid.org/0000-0001-7808-5911)"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
    fig_caption: yes
    fig_width: 3.5
    fig_height: 3.5
    dpi: 72
    dev.args: list(pointsize=11)
vignette: >
  %\VignetteIndexEntry{1. Introduction to ocencdf}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options:
  markdown:
    wrap: 72
---

<!--
Building this vignette.

1. Edit vignettes/oce.Rmd in a plain-text editor.

2. In a unix shell at the level above ocencdf, type the following:

       R CMD build --compact-vignettes="qpdf" ocencdf
       R CMD install ocencdf_0.0-1.tar.gz

   where the version number may need adjustment in the second command.

3. To see the results, type the following in an R console:

      browseVignettes("ocencdf")
-->

```{r, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

# Purpose

The package provides a way to store approximate forms of oce objects as Netcdf
files.  This can be useful because the Netcdf format is handled by many
computing languages, making it a good intermediate format in multi-language
processing, as well as a sensible choice for data archiving.

# Limitations of Netcdf format

Unfortunately, direct transferral of R information to Netcdf is not possible.
This is because Netcdf is an array-oriented format that is not designed to hold
tree-oriented data such as R lists (which are used throughout oce).  It is
possible to flatten simple lists, but the process gets complicated for nested
lists, which are common in oce.  Other difficulties with the Netcdf format
include its lack of basic elements programming elements such as user-defined
classes and variable-length character strings in the data portion of the files.

This package is in early development, and efforts are focussed on a single oce
class, the ctd object.  This focus is intended to permit coding practices to gel,
in preparation for the addition of other classes.  Given the anticipated needs
of users, the next planned item for support is ADCP data.

# How the package works

## Focus elements

The design goal is to save the following elements

1. Entries in the `data` slot (e.g. temperature, salinity, etc.), renamed as appropriate.
2. The `metadata` slot (saved in a string form as a global attribute).
3. An approximate form of units, as strings (to fit Netcdf conventions).
4. Information on the conversion process.

## Renaming elements

Oce uses a restricted set of names for certain variables.  For example, in ctd
objects, temperature is called `temperature`, and if the ctd had two temperature
sensors, there would be an additional entry called `temperature2`.  These are
not typically the names used in raw data files, however.  More commonly,
temperature might be named `TEMP`, for example.  In recognition of this, ocencdf
provides a way to rename oce objects using other systems of names.  The mapping
between oce name and other name is controlled by YAML (yet another markup
language) files, which are called varTables in this package. Tables are provided
for the Argo system and for the World Hydographic Program system. These are
available as `"argo"` and `"whp"`, respectively.  They are stored in the
`inst/extdata` directory of the package source tree. Users seeking to define new
naming systems must copy the formats of those files.

# Example with CTD data

The first step is to create an oce object, e.g. station 100 of the built-in
`section` dataset.  Note the variable names, units, and flag values in the
summary.

```{r}
library(ocencdf)
library(oce)
data(section)
stn <- section[["station", 100]]
summary(stn)
```

Now, save as a netcdf file, using (say) the Argo convention for variable names.

```{r}
oce2ncdf(stn, varTable="argo", ncfile="stn.nc")
```

The `stn.nc` file may be examined in various ways, but we leave that up to the
reader.  Note that the column names are e.g. `TEMP` in the Netcdf file,
because the varTable named `"argo"` establishes that nickname.

In R, we can read `stn.nc` into a ctd object and get a summary with the following.

```{r}
A <- ncdf2ctd("stn.nc", varTable="argo")
summary(A)
```

```{r echo=FALSE}
unlink("stn.nc")
```

